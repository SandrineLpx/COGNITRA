# Iteration Log (Full / Historical)

This file preserves detailed step-by-step history, including superseded intermediate fixes.
Use `ITERATION_LOG.md` as the current authoritative milestone log.

Use this file to track changes by iteration in a concise way.

## Format
| Iteration | Date | Update | Reason | Improvement |
|---|---|---|---|---|
| v0.0 | YYYY-MM-DD | What changed | Why it changed | What got better |

## Entries
| Iteration | Date | Update | Reason | Improvement |
|---|---|---|---|---|
| v1.0 | 2026-02-11 | Replaced `call_model()` stub with local deterministic fallback in `src/model_router.py`. | App crashed with `NotImplementedError` during ingest pipeline. | Pipeline now runs end-to-end without external SDK wiring. |
| v1.1 | 2026-02-11 | Added `S&P` and `MarkLines` to allowed source types in validation. | Needed support for additional source categories. | Records with these source types now pass schema validation. |
| v1.2 | 2026-02-11 | Added `src/constants.py` and moved schema constants from `src/schema_validate.py`. | Centralize shared constants and reduce duplication. | Cleaner structure and easier maintenance of schema rules. |
| v1.3 | 2026-02-11 | Added `regions_mentioned` validation (list + no duplicates). | Strengthen data quality and consistency. | Better geographic metadata integrity for downstream filtering/reporting. |
| v1.4 | 2026-02-11 | Implemented `postprocess_record()` in `src/postprocess.py` to normalize/dedupe countries and regions. | Needed consistent geography normalization before save. | Cleaner, de-duplicated `country_mentions` and `regions_mentioned`. |
| v1.5 | 2026-02-11 | Derived strict `regions_relevant_to_kiekert` from `country_mentions` footprint mapping and merged into `regions_mentioned`. | Support two-layer region model (open-set mentions + strict footprint relevance). | Reliable footprint relevance flag while preserving broader regional context. |
| v1.6 | 2026-02-11 | Updated `pages/01_Ingest.py` to call `postprocess_record(rec)` after model routing; updated schema to keep `regions_relevant_to_kiekert` strict and `regions_mentioned` open-set (unique, max 15). | Ensure records are normalized before persistence and validation matches new design. | Reduced downstream cleanup and aligned validation with intended data model. |
| v1.7 | 2026-02-11 | Updated `README.md` model-routing notes to match current behavior. | Documentation still described `call_model()` as a stub. | Reduced confusion between code behavior and setup docs. |
| v1.8 | 2026-02-11 | Updated `src/model_router.py` to import shared constants from `src/constants.py` directly. | Improve module layering and avoid indirect constant imports through validation module. | Cleaner dependency boundaries in `src/`. |
| v1.9 | 2026-02-11 | Ran one-time normalization on existing `data/records.jsonl` via `postprocess_record()`. | Older records predated the two-layer region normalization rules. | Stored geography fields now align with current schema and postprocessing behavior. |
| v1.10 | 2026-02-11 | Wired `call_model()` to Gemini REST API using `GEMINI_API_KEY`/`GOOGLE_API_KEY` and configurable `GEMINI_MODEL`; retained local fallback on missing key or API failure. | Enable real model calls while keeping app usable without external credentials. | `provider=gemini` can now use live API responses for extraction/repair prompts. |
| v1.11 | 2026-02-11 | Refactored `call_model()` to use `google-genai` SDK for Gemini with structured output (`response_mime_type=application/json`, `response_schema`), and placeholders for Claude/ChatGPT. | Needed strict schema-aligned JSON generation through official SDK integration. | Gemini responses are now schema-constrained JSON with clearer provider error handling. |
| v1.12 | 2026-02-11 | Clarified extraction prompt rule that `source_type` should represent the publisher/source outlet. | Reduce ambiguity in model output for source classification. | More consistent `source_type` values aligned with allowed publisher labels. |
| v1.13 | 2026-02-11 | Updated `_infer_actor_type()` to avoid defaulting to `regulator` from government entity mentions alone; `companies_mentioned` now defaults to `oem` unless explicit regulator-action verbs are present. | Prior logic over-labeled mixed articles as regulatory. | Better actor-type precision for company-led articles with incidental government mentions. |
| v1.14 | 2026-02-12 | Removed `additionalProperties` from Gemini `response_schema` in `src/model_router.py`. | Gemini API rejected schema due to unsupported keyword. | Gemini structured-output call now aligns with supported schema features. |
| v1.15 | 2026-02-12 | Converted Gemini response schema to SDK-compatible format (uppercase type enums, `nullable` for optionals, removed unsupported `uniqueItems` and union-type lists). | Gemini SDK validation rejected JSON-schema-style fields. | Structured output now matches `google-genai` schema requirements and should pass request validation. |
| v1.16 | 2026-02-12 | Synced docs/constants after version drift: updated `README.md` model-routing notes to current Gemini SDK behavior and switched `src/postprocess.py` to import `FOOTPRINT_REGIONS` from `src/constants.py`. | Repo had mixed historical notes and duplicated constants. | Documentation now matches runtime behavior and footprint region values come from one shared source. |
| v1.17 | 2026-02-12 | Added Streamlit secrets support for Gemini key lookup in `src/model_router.py` (`GEMINI_API_KEY` env first, then `st.secrets`), created `.streamlit/secrets.toml.example`, and ignored `.streamlit/secrets.toml` in `.gitignore`. | Improve local key management and avoid committing real credentials. | App can read keys from Streamlit secrets with env fallback, with safer repo defaults for secrets handling. |
| v1.18 | 2026-02-12 | Tightened geography normalization in `src/postprocess.py`: `regions_mentioned` now resolves to footprint buckets only (from country mapping + explicit region hints), and `government_entities` now removes country entries while keeping regulator bodies; updated validation to enforce footprint-only `regions_mentioned`. | Prevent non-region noise in region fields and reduce country/regulator mix-ups in entities. | Cleaner, controlled region metadata and more consistent government entity tagging. |
| v1.19 | 2026-02-12 | Added schema-level date pattern constraint for `publish_date` in `src/model_router.py` (`YYYY-MM-DD`). | Improve extraction reliability for date normalization. | Structured output now explicitly enforces ISO date formatting for non-null `publish_date`. |
| v1.20 | 2026-02-12 | Updated `src/postprocess.py` to normalize `US` in `country_mentions` to `United States` and null out `original_url` unless it matches an HTTP(S) URL regex. | Improve consistency for country aliases and prevent invalid URL-like strings from persisting. | Cleaner country normalization and safer `original_url` values before validation/storage. |
| v4.6 | 2026-02-16 | Added deterministic postprocess safeguards for Mercedes/Bloomberg regressions: `mentions_our_company` computed from source-grounded fields only; publisher header date overrides with diagnostics (`_publisher_date_override_applied`, `_publisher_date_override_source`); event-date detection excludes header timestamp lines. | LLM output could mark false company mentions and confuse event dates with publication timestamps. | Higher factual consistency and auditability for publish/event dates and company-mention-derived priority logic. |
| v4.7 | 2026-02-16 | Improved macro-theme precision and SDV triggering: excluded `notes` from macro-theme text matching; expanded SDV company signals and legal-entity company canonicalization; added SDV strength calibration and structural rollup support. | Theme matching had false positives from analyst commentary and false negatives from legal-entity name variants. | More reliable macro-theme firing (`macro_themes_detected`), cleaner `_macro_theme_detail` field provenance, and stronger SDV/China disruption detection with regression coverage. |
| v4.8 | 2026-02-16 | Migrated footprint regions to Option B (`Western Europe`, `Eastern Europe`, `Russia`) in constants + postprocess bucketing; added legacy migration and ambiguity diagnostics (`_region_migrations`, `_region_ambiguity`). | Legacy region label `Europe (including Russia)` was too coarse and obscured geopolitical/regional signal differences. | Deterministic region granularity with backward compatibility for old records and explicit audit hints for defaults/migrations. |
| v4.9 | 2026-02-16 | Refined ingest/synthesis UX and prompts: removed manual chunk toggle in Ingest (automatic chunking by metadata), strengthened extraction numeric-evidence instruction in `src/model_router.py`, and tightened weekly synthesis prompt in `src/briefing.py` (numeric enforcement, Tier-1 lens, tone constraints, length scaling, rollup elevation guidance). | Needed clearer analyst UX and more executive-grade, grounded weekly output without changing schema or deterministic postprocess boundaries. | Better prompt quality and consistency with existing deterministic pipeline; full pytest suite remains passing after updates. |
| v5.0 | 2026-02-17 | Fixed `regions_bucketed_deduped` dropping primary LLM-extracted regions; added "Asia" to `FOOTPRINT_REGIONS`, added Asian countries (Japan, South Korea, Taiwan, Indonesia, Vietnam, Malaysia, Philippines, Singapore, Australia, New Zealand) to `COUNTRY_TO_FOOTPRINT`, added `REGION_ALIASES` for asia/apac/asia-pacific, added `_CITY_REGION_HINTS` for Tokyo/Osaka/Nagoya/Seoul/Taipei/Jakarta. | Bloomberg Toyota CEO article produced `regions_mentioned=["Asia"]` from LLM, but `regions_bucketed_deduped()` dropped it because "Asia" was not in `FOOTPRINT_REGIONS`. Only US and China survived from country-mention mappings. | Primary LLM-extracted regions are now preserved; country-inferred regions are added without removing existing ones; city-name hints provide additional region inference; 8 new tests in `tests/test_regions_bucketed.py`. |
| v5.1 | 2026-02-17 | Added "Japan" as standalone entry in `FOOTPRINT_REGIONS`; changed `COUNTRY_TO_FOOTPRINT["Japan"]` from "Asia" to "Japan"; city hints for Tokyo/Osaka/Nagoya now produce `["Japan", "Asia"]`. | Japan is a Kiekert-relevant market (Toyota, Honda, Nissan headquarters) and needs country-level granularity in `regions_relevant_to_kiekert` — generic "Asia" loses the Japan-specific signal. | Japan appears as its own footprint region; articles about Japanese OEMs get both `Japan` (in kiekert regions) and `Asia` (in display regions); tests updated. |
| v5.2 | 2026-02-17 | Expanded `COUNTRY_TO_FOOTPRINT` with ~18 new countries: Canada→US, Sweden/Austria/Belgium/Netherlands/Portugal/Denmark/Finland/Ireland→Western Europe, Serbia/Croatia/Slovenia→Eastern Europe, Egypt/Nigeria/Kenya→Africa, South Korea/Taiwan/Indonesia/Vietnam/Malaysia/Philippines/Singapore/Australia/New Zealand→Asia. Relaxed schema: topics max 3→4, keywords 5-12→3-15. Added `ALLOWED_SOURCE_TYPES`: "Financial News", "Industry Publication". Added `ALLOWED_ACTOR_TYPES`: "technology". Updated extraction prompt with source_type and actor_type guidance. Special handling: Canada triggers `_has_explicit_us_signal` for US region mapping. | Gap audit found: many countries mentioned in real articles had no mapping (silently lost); schema rejected valid 4-topic articles; "Other" was overused for Financial News/Industry Publications; no actor_type for tech companies like Nvidia/Qualcomm. | Broader country coverage prevents silent region loss; schema accepts valid multi-topic articles; better source/actor classification; 9 new tests, all 89 pass. |
| v5.3 | 2026-02-17 | Created two-tier region architecture: `DISPLAY_REGIONS` = [Asia, Western Europe, Eastern Europe, Africa, US, Latin America] for `regions_mentioned`; `FOOTPRINT_REGIONS` retains country-level entries for `regions_relevant_to_kiekert`; `FOOTPRINT_TO_DISPLAY` collapse map (India/China/Japan/Thailand→Asia, Mexico→Latin America, Russia→Eastern Europe). Updated `postprocess.py` to collapse before writing `regions_mentioned`. Updated `schema_validate.py` to validate against `DISPLAY_REGIONS`. Updated macro-theme region matching to use union of both fields. Fixed Tariff theme: removed "Asia" from `region_requirements` (too broad — Thailand→Asia would false-fire). | User feedback: "regions_mentioned should be only region, not countries." The field was mixing `["Japan", "India", "Asia"]`, making analytics noisy. Country-level detail belongs in `regions_relevant_to_kiekert` and `country_mentions`. | Clean separation: `regions_mentioned` = broad geographic buckets only; `regions_relevant_to_kiekert` = country-level Kiekert operational granularity; macro themes still match at country level via the union; `test_regions_bucketed.py` rewritten with 17 display-region tests + 6 schema relaxation tests; all 89 pass. |
| v5.4 | 2026-02-17 | Consolidated `References/SKILL.md` into `AGENTS.md`: merged unique content (Kiekert domain scope, ingest flow steps, priority scoring heuristics, review gating rules, two-tier region architecture documentation); moved SKILL.md to `References/Archives/SKILL.md`; reduced `CLAUDE.md` to 3-line pointer to `AGENTS.md`; updated test commands to use `tests/` directory. | SKILL.md in repo root overlapped heavily with CLAUDE.md/AGENTS.md but contained outdated information: wrong page layout (referenced non-existent pages), removed schema fields (`strategic_implications`, `recommended_actions`), old actor_type values (`tech_partner`, `government`, `regulator`), old review statuses, old region buckets. | Single canonical instruction file (`AGENTS.md`) for all AI agents and human engineers; no duplicate/outdated spec files; architecture, constraints, and pipeline rules all in one place. |
| v5.5 | 2026-02-17 | Analyzed redundancy between `References/topic-taxonomy.md`, `References/context-watchlist.md`, and `AGENTS.md`. Cleaned both files: removed outdated "Footprint regions" section from watchlist (old `Europe (including Russia)`), removed duplicate "Priority Assessment" section, removed "Article Categorization Rules" (overlap with AGENTS.md). Renamed `context-watchlist.md` → `company-watchlist.md`. Created `References/QUARTERLY_REVIEW.md` maintenance checklist. | topic-taxonomy.md had topic names triply-defined (file + AGENTS.md + constants.py); context-watchlist.md had 3 outdated sections (regions, country roll-ups, priority rules) but 3 sections of unique value (competitors, OEMs, tech partners). Maintenance required touching 5+ files. | Reference files reduced from 3 to 2: `company-watchlist.md` (competitive intelligence only, no code duplication) and `topic-taxonomy.md` (tagging guidance only, defers to code for topic names). Quarterly review formalized with risk-ordered checklist. |
| v5.6 | 2026-02-17 | Embedded topic tagging guidance and competitor context into extraction prompt (`src/model_router.py` → `extraction_prompt()`): added Kiekert identity as prompt opening; added per-topic use/don't-use rules in TOPIC CLASSIFICATION section; added Tier 1/2 closure competitors in CLOSURE SYSTEMS COMPETITORS section. Moved topic guidance into `src/constants.py` as structured comments above `CANON_TOPICS`. Deleted `References/topic-taxonomy.md` (content now in code). Updated `QUARTERLY_REVIEW.md` to reflect 3-file structure. | The LLM received only topic names in the schema enum with zero disambiguation guidance — it had to guess boundaries between similar topics (e.g., "OEM Strategy" vs "OEM Programs"). Topic tagging guidance and competitor lists existed in reference .md files but were never wired into the prompt. Maintenance required 4-5 file changes per topic update. | LLM now receives domain context (Kiekert identity), topic classification rules (use/don't-use per topic), and competitor recognition (correct actor_type='supplier' + mentions_our_company). Topic guidance maintained in 2 places (code comments + prompt) instead of 4-5. Deleted topic-taxonomy.md; all 89 tests pass. |
| v5.7 | 2026-02-17 | Documented spec-to-code consolidation in technical report (`Docs/technical_report_v1.0.md`): rewrote §6.1 as 3-phase narrative (spec-first → drift → consolidation with Phase 3 final structure table + ASCII diagram placeholder); added §7.5.8 as meaningful iteration (problem/options-considered table/approach/before-after prompt/performance impact/bottleneck/workaround); added `AGENTS.md` as single operator manual (point 5 in Phase 3); updated §10.1 with v4.7 spec-to-code lesson; updated §10.2 with spec-drift challenge. Updated iteration logs. | Technical report assignment requires documenting design decisions, iterations, bottlenecks, and the building process transparently. The spec-to-code consolidation was the most meaningful iteration for LLM classification quality and needed proper documentation. | Report covers the full evolution transparently: what started well (spec-first design), what went wrong (drift during AI-assisted iteration), how it was fixed (embed guidance where consumed), and the lesson learned (specifications not consumed at runtime become liabilities). |
| v5.8 | 2026-02-17 | Completed organization hardening pass: added `pyproject.toml` + `requirements.txt`, updated install docs in `README.md`, expanded `.gitignore`, and removed tracked runtime artifacts (`src/__pycache__/*.pyc`, `data/pdfs/*`) from version control index. | Repo had generated/runtime files in git history and no canonical project metadata file for reproducible setup. | Cleaner repository hygiene, clearer onboarding/install path, and lower risk of accidental binary/cache commits. |
| v5.9 | 2026-02-17 | Consolidated duplicate processing paths: made `src/dedupe.py` the canonical dedupe+rank implementation (`dedup_and_rank`), converted `src/dedup_rank.py` to compatibility wrapper, and aligned legacy cleaners (`src/clean_text.py`, `src/text_cleanup.py`) to use `src/text_clean_chunk.py`. | Parallel implementations were creating maintenance drift risk and potential behavioral inconsistencies between ingest, dashboard/admin, and weekly brief flows. | Single core path for dedupe/cleaning behavior across ingest-to-brief pipeline; reduced code drift; full test suite remained passing. |
| v6.0 | 2026-02-17 | Standardized agent-instruction files for cross-LLM tooling: created canonical `AGENTS.md` and converted `CLAUDE.md` into a pointer wrapper. | Tool-specific instruction files increase maintenance overhead and can diverge over time. | One source of truth for agent instructions with backward compatibility for Claude-style tooling. |
| v6.1 | 2026-02-17 | Performed runtime context-path audit for ingest and weekly brief generation; confirmed `References/*.md` files are advisory and not consumed by runtime extraction/brief logic. | Needed architectural clarity before wiring additional context into prompts and cleaning documentation scope. | Clear separation between runtime inputs (PDF/chunks/JSON records) and human reference docs; reduced ambiguity about where quality improvements must be implemented. |
