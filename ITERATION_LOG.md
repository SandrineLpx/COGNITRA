# Iteration Log (Clean)

Concise milestone log. Full detailed history is preserved in `ITERATION_LOG_FULL.md`.

| Iteration | Date | Update | Reason | Improvement |
|---|---|---|---|---|
| v1.0 | 2026-02-11 | Replaced `call_model()` stub in `src/model_router.py` with a working extraction pipeline. | App was blocked by `NotImplementedError` during ingest. | End-to-end ingest path became runnable. |
| v1.1 | 2026-02-11 | Expanded source taxonomy (`S&P`, `MarkLines`) and centralized schema constants in `src/constants.py`. | Needed additional publisher labels and cleaner shared config. | Consistent enums and easier maintenance across modules. |
| v1.2 | 2026-02-11 | Introduced two-layer geography processing in `src/postprocess.py` and integrated it into ingest/router flow. | Needed normalized geographic fields and strict footprint relevance. | Cleaner `country_mentions`, controlled `regions_mentioned`, reliable `regions_relevant_to_kiekert`. |
| v1.3 | 2026-02-11 | Strengthened validation in `src/schema_validate.py` (duplicates, size bounds, footprint checks). | Reduce malformed records entering storage. | Higher record quality and safer downstream analytics. |
| v1.4 | 2026-02-12 | Wired Gemini via `google-genai` with structured output schema and provider routing/logging. | Needed production model calls instead of local-only behavior. | Deterministic JSON extraction with clearer provider errors. |
| v1.5 | 2026-02-12 | Hardened Gemini schema compatibility (SDK-valid types/nullable handling) and prompt rules for extraction reliability. | Early API calls failed on unsupported schema shapes. | Stable Gemini request/response behavior and better extraction consistency. |
| v1.6 | 2026-02-12 | Added secrets support (`.streamlit/secrets.toml` + env fallback), secrets template, and `.gitignore` protection. | Simplify local key management and avoid leaking credentials. | Safer configuration workflow for API keys. |
| v1.7 | 2026-02-12 | Aligned docs and repo hygiene (`README` updates, constants consistency, data normalization pass). | Version drift between implementation and documentation. | Clearer onboarding and consistent behavior across existing/new records. |
| v1.8 | 2026-02-12 | Implemented duplicate detection and story-level deduplication in `src/dedupe.py`. | Needed to prevent same story from appearing multiple times across publishers when exporting/reporting. | Canonical record selection with detailed publisher ranking (S&P=100 > Bloomberg=90 > Reuters=80 > ... Other=50), confidence scoring, and completeness scoring. |
| v1.9 | 2026-02-12 | Added CLI script `scripts/dedupe_jsonl.py` for bulk JSONL deduplication and export. | Enable analysts to generate deduplicated datasets (canonical + duplicates JSONL files) without hitting Streamlit UI limits. | Deterministic deduplication output with CSV export support; includes diagnostic stats (dedup rate, duplicate count). |
| v2.0 | 2026-02-12 | Created weekly briefing module `src/briefing.py` with weekly candidate selection and executive email generation. | Needed structured workflow to select, filter, and draft weekly intelligence summaries for stakeholders. | Auto-suppresses duplicates in briefs; prioritizes High/High (share-ready) items; renders Markdown brief + email body templates. |
| v2.1 | 2026-02-12 | Added new page `pages/06_Weekly_Brief.py` for weekly digest workflow. | Enable analysts to select items for the week, preview, and draft executive emails with one-click share-ready suggestions. | Selectable candidate list, multi-item filtering by date range, and template email generation. |
| v2.2 | 2026-02-12 | Integrated deduplication toggle into Dashboard (`pages/04_Dashboard.py`) and Export/Admin (`pages/05_Export_Admin.py`). | Allow users to see analytics on canonical vs. all records; enable export in either mode. | Added sidebar toggle for Dashboard; added metrics and bulk export button in Export/Admin for canonical/duplicates JSONL. |
| v2.3 | 2026-02-12 | Created comprehensive test suite `test_scenarios.py` with 25+ test cases covering duplicate detection, deduplication, source ranking, weekly briefing logic. | Ensure quality and regression prevention as new features are added. | Full scenario coverage: exact duplicate detection, similar story matching, publisher ranking hierarchy, briefing workflow. |
| v2.4 | 2026-02-12 | Applied repo hygiene fixes: moved URL override before postprocess in ingest, expanded `.gitignore` for local/dev artifacts, and marked `ITERATION_LOG_FULL.md` as historical/superseded detail. | Prevent URL sanitation bypass, reduce accidental local-file commits, and clarify which log is authoritative. | More reliable ingest normalization, cleaner version control hygiene, and lower documentation confusion. |
| v2.5 | 2026-02-12 | Standardized Gemini schema strategy in `src/model_router.py` to SDK-style `type` + `nullable` fields (removed mixed nullable styles), and normalized validation message text in `src/schema_validate.py` to ASCII ranges. | Reduce schema compatibility churn and remove UI/log text encoding artifacts. | More stable model-call behavior and cleaner, consistent validation messages. |
| v2.6 | 2026-02-13 | Replaced basic context assembly with deterministic chunk selection (`src/context_pack.py`) and ingest-side chunk diagnostics (`pages/01_Ingest.py`). | Raw PDF text included too much noise and weak signal prioritization for model prompts. | Higher-signal context packs (header + body chunking/scoring) with bounded size and optional visibility into selected chunks/flags. |
| v2.7 | 2026-02-13 | Improved extraction reliability by passing `ORIGINAL_URL` into context and adding deterministic postprocess inference for `publish_date` + `source_type` (`src/postprocess.py`, `pages/01_Ingest.py`). | Model-only extraction missed obvious dates/publisher markers in messy documents. | Better date fill-rate (ISO conversion from common patterns), stronger publisher classification (S&P/MarkLines/Automotive News/Reuters), and safer manual URL precedence. |
| v2.8 | 2026-02-13 | Added conservative text cleanup stage (`src/text_cleanup.py`) and ingest controls/previews for raw vs cleaned text with removal diagnostics. | Noisy PDF exports (ads/nav/license/link farms) were degrading entity/topic/date extraction quality. | Deterministic boilerplate suppression, repeated line/block dedupe, and fallback guard to avoid over-cleaning; cleaner input for chunking and LLM extraction. |
