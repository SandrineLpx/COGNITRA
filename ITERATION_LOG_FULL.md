# Iteration Log

Use this file to track changes by iteration in a concise way.

## Format
| Iteration | Date | Update | Reason | Improvement |
|---|---|---|---|---|
| v0.0 | YYYY-MM-DD | What changed | Why it changed | What got better |

## Entries
| Iteration | Date | Update | Reason | Improvement |
|---|---|---|---|---|
| v1.0 | 2026-02-11 | Replaced `call_model()` stub with local deterministic fallback in `src/model_router.py`. | App crashed with `NotImplementedError` during ingest pipeline. | Pipeline now runs end-to-end without external SDK wiring. |
| v1.1 | 2026-02-11 | Added `S&P` and `MarkLines` to allowed source types in validation. | Needed support for additional source categories. | Records with these source types now pass schema validation. |
| v1.2 | 2026-02-11 | Added `src/constants.py` and moved schema constants from `src/schema_validate.py`. | Centralize shared constants and reduce duplication. | Cleaner structure and easier maintenance of schema rules. |
| v1.3 | 2026-02-11 | Added `regions_mentioned` validation (list + no duplicates). | Strengthen data quality and consistency. | Better geographic metadata integrity for downstream filtering/reporting. |
| v1.4 | 2026-02-11 | Implemented `postprocess_record()` in `src/postprocess.py` to normalize/dedupe countries and regions. | Needed consistent geography normalization before save. | Cleaner, de-duplicated `country_mentions` and `regions_mentioned`. |
| v1.5 | 2026-02-11 | Derived strict `regions_relevant_to_kiekert` from `country_mentions` footprint mapping and merged into `regions_mentioned`. | Support two-layer region model (open-set mentions + strict footprint relevance). | Reliable footprint relevance flag while preserving broader regional context. |
| v1.6 | 2026-02-11 | Updated `pages/01_Ingest.py` to call `postprocess_record(rec)` after model routing; updated schema to keep `regions_relevant_to_kiekert` strict and `regions_mentioned` open-set (unique, max 15). | Ensure records are normalized before persistence and validation matches new design. | Reduced downstream cleanup and aligned validation with intended data model. |
| v1.7 | 2026-02-11 | Updated `README.md` model-routing notes to match current behavior. | Documentation still described `call_model()` as a stub. | Reduced confusion between code behavior and setup docs. |
| v1.8 | 2026-02-11 | Updated `src/model_router.py` to import shared constants from `src/constants.py` directly. | Improve module layering and avoid indirect constant imports through validation module. | Cleaner dependency boundaries in `src/`. |
| v1.9 | 2026-02-11 | Ran one-time normalization on existing `data/records.jsonl` via `postprocess_record()`. | Older records predated the two-layer region normalization rules. | Stored geography fields now align with current schema and postprocessing behavior. |
| v1.10 | 2026-02-11 | Wired `call_model()` to Gemini REST API using `GEMINI_API_KEY`/`GOOGLE_API_KEY` and configurable `GEMINI_MODEL`; retained local fallback on missing key or API failure. | Enable real model calls while keeping app usable without external credentials. | `provider=gemini` can now use live API responses for extraction/repair prompts. |
| v1.11 | 2026-02-11 | Refactored `call_model()` to use `google-genai` SDK for Gemini with structured output (`response_mime_type=application/json`, `response_schema`), and placeholders for Claude/ChatGPT. | Needed strict schema-aligned JSON generation through official SDK integration. | Gemini responses are now schema-constrained JSON with clearer provider error handling. |
| v1.12 | 2026-02-11 | Clarified extraction prompt rule that `source_type` should represent the publisher/source outlet. | Reduce ambiguity in model output for source classification. | More consistent `source_type` values aligned with allowed publisher labels. |
| v1.13 | 2026-02-11 | Updated `_infer_actor_type()` to avoid defaulting to `regulator` from government entity mentions alone; `companies_mentioned` now defaults to `oem` unless explicit regulator-action verbs are present. | Prior logic over-labeled mixed articles as regulatory. | Better actor-type precision for company-led articles with incidental government mentions. |
| v1.14 | 2026-02-12 | Removed `additionalProperties` from Gemini `response_schema` in `src/model_router.py`. | Gemini API rejected schema due to unsupported keyword. | Gemini structured-output call now aligns with supported schema features. |
| v1.15 | 2026-02-12 | Converted Gemini response schema to SDK-compatible format (uppercase type enums, `nullable` for optionals, removed unsupported `uniqueItems` and union-type lists). | Gemini SDK validation rejected JSON-schema-style fields. | Structured output now matches `google-genai` schema requirements and should pass request validation. |
| v1.16 | 2026-02-12 | Synced docs/constants after version drift: updated `README.md` model-routing notes to current Gemini SDK behavior and switched `src/postprocess.py` to import `FOOTPRINT_REGIONS` from `src/constants.py`. | Repo had mixed historical notes and duplicated constants. | Documentation now matches runtime behavior and footprint region values come from one shared source. |
| v1.17 | 2026-02-12 | Added Streamlit secrets support for Gemini key lookup in `src/model_router.py` (`GEMINI_API_KEY` env first, then `st.secrets`), created `.streamlit/secrets.toml.example`, and ignored `.streamlit/secrets.toml` in `.gitignore`. | Improve local key management and avoid committing real credentials. | App can read keys from Streamlit secrets with env fallback, with safer repo defaults for secrets handling. |
| v1.18 | 2026-02-12 | Tightened geography normalization in `src/postprocess.py`: `regions_mentioned` now resolves to footprint buckets only (from country mapping + explicit region hints), and `government_entities` now removes country entries while keeping regulator bodies; updated validation to enforce footprint-only `regions_mentioned`. | Prevent non-region noise in region fields and reduce country/regulator mix-ups in entities. | Cleaner, controlled region metadata and more consistent government entity tagging. |
| v1.19 | 2026-02-12 | Added schema-level date pattern constraint for `publish_date` in `src/model_router.py` (`YYYY-MM-DD`). | Improve extraction reliability for date normalization. | Structured output now explicitly enforces ISO date formatting for non-null `publish_date`. |
| v1.20 | 2026-02-12 | Updated `src/postprocess.py` to normalize `US` in `country_mentions` to `United States` and null out `original_url` unless it matches an HTTP(S) URL regex. | Improve consistency for country aliases and prevent invalid URL-like strings from persisting. | Cleaner country normalization and safer `original_url` values before validation/storage. |
